<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jokester: The Card Game</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background-color: #991111;
      color: #fff;
      font-family: 'Georgia', serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #terminal {
      width: 80vw;
      height: 80vh;
      background-color: rgba(0,0,0, 0.8);
      padding: 30px;
      border-radius: 8px;
      border: 3px double gold;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #output {
      color: #ffdd99;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 15px;
      margin-bottom: 10px;
      overflow-y: auto;
      width: 100%;
      height: 100%;
      flex-grow: 1;
      font-size: 1.1em;
      box-sizing: border-box;
      word-wrap: break-word;
    }
    #output::-webkit-scrollbar-track {
      background-color: #000;
      border-radius: 10px;
    }
    #output::-webkit-scrollbar-thumb {
      background-color: gold;
      border-radius: 10px;
      border: 2px solid #000;
    }
    #output::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    #output {
      scrollbar-width: thin;
      scrollbar-color: gold #000;
    }
    #input-area {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    #user-input {
      width: 100%;
      background-color: transparent;
      color: inherit;
      border: none;
      outline: none;
      font-size: 1.2em;
      margin-left: 0;
    }
    #prompt {
      display: inline-block;
      font-size: 1.5em;
      color: gold;
    }
    #rulesButton {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: gold;
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 24px;
      line-height: 24px;
    }
    #rulesPopup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      overflow: auto;
    }
    #rulesContent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      color: black;
      text-align: center;
      max-height: 80%;
      overflow-y: auto;
    }
    #rulesHeader {
      text-align: right;
    }
    #closeButton {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    /* Mobile-specific styles */
    body.mobile #terminal {
      width: 95vw;
      height: 95vh;
      padding: 10px;
    }
    body.mobile #output {
      padding: 5px;
      font-size: 0.9em;
    }
    body.mobile #input-area {
      flex-direction: column;
      align-items: stretch;
    }
    body.mobile #user-input {
      font-size: 1em;
      margin-top: 5px;
      pointer-events: none; /* Prevents keyboard from appearing */
    }
    body.mobile #rulesButton {
      font-size: 14px;
      padding: 5px 10px;
    }
    body.mobile #rulesContent {
      width: 90%;
      max-height: 80%;
      padding: 10px;
    }
    body.mobile #closeButton {
      font-size: 16px;
    }
    body.mobile h2, body.mobile h3 {
      font-size: 1.2em;
    }
    body.mobile p, body.mobile li {
      font-size: 1em;
    }
    #mobile-buttons {
      display: none;
      flex-direction: row;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .mobile-button {
      background-color: gold;
      color: black;
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
      margin: 3px;
      cursor: pointer;
      flex: 1 1 18%;
      text-align: center;
    }
    .send-button {
      background-color: black;
      color: gold;
      border: 2px solid gold;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
      margin: 3px;
      cursor: pointer;
      flex: 1 1 40%;
      text-align: center;
    }
  </style>
  <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
  <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
</head>
<body>
  <div id="terminal">
    <div id="output"></div>
    <div id="input-area">
      <span id="prompt" class="hearts"> $ </span>
      <input type="text" id="user-input" placeholder="Enter commands..." onkeydown="handleKeyDown(event)">
      <button id="rulesButton">Rules</button>
    </div>
    <div id="mobile-buttons"></div>
  </div>

  <div id="rulesPopup">
    <div id="rulesContent">
      <div id="rulesHeader">
        <button id="closeButton">&#10006;</button>
      </div>
      <h2>Rules for play:</h2>
      <h1><strong>Game Overview:</strong></h1>
      <p>This game is a strategic card game that uses standard playing cards, including Jokers. The main objective is to collect sets of four cards and strategically utilize Jokers, which can instantly represent a set of four.</p>
      <h2><strong>Game Setup:</strong></h2>
      <ul>
        <li><strong>Deck Composition</strong>: Two standard 54-card decks (including Jokers) are used.</li>
        <li><strong>Players</strong>: 2 to 10 players can participate. The game accommodates both AI and human players.</li>
        <li><strong>Starting Hands</strong>: Players begin with 12 cards if there are 2 players, or 10 cards if more than 2 players are playing.</li>
      </ul>
      <h2>Game Play:</h2>
      <h3>1. <strong>Shuffling and Dealing</strong>:</h3>
      <p>Begin by shuffling the deck thoroughly and dealing the determined number of cards to each player.</p>
      <h3>2. <strong>Turns</strong>:</h3>
      <p>Players take turns in a clockwise direction. Each turn consists of a drawing phase, a playing phase, and a discarding phase.</p>
      <h3>3. <strong>Drawing Cards</strong>:</h3>
      <p>Players may draw two cards from the deck or one card from the discard pile on their turn. Opting for cards from the discard pile is a strategic move that can reveal what a player might be trying to collect.</p>
      <h3>4. <strong>Playing Sets</strong>:</h3>
      <p>A set consists of four cards of the same rank. Jokers are powerful, acting as a complete set on their own (equivalent to four identical cards). Players announce sets to accumulate points.</p>
      <h3>5. <strong>Discarding</strong>:</h3>
      <p>If unable to play a set, players must discard a card to the central discard pile, which is visible to all players.</p>
      <h3>6. <strong>Jokers as Instant Sets</strong>:</h3>
      <p>Jokers can be declared as an instant set, dramatically influencing the state of the game. They can also be used to claim the discard pile, providing a significant strategic advantage.</p>
      <h3>7. <strong>Jokester Calls</strong>:</h3>
      <p>A "Jokester" declaration allows a player to claim the discard pile using either a set of four, a Joker, or a bluff. Other players can challenge this declaration, and incorrect challenges result in discarding two card as a penalty.</p>
      <h2><strong>Winning the Game:</strong></h2>
      <ul>
        <li>The game ends when the deck is exhausted.</li>
        <li>The player with the highest number of sets at the end wins. Collecting four Jokers enables a player to win immediately.</li>
      </ul>
      <h2><strong>Special Rules:</strong></h2>
      <p><strong>Bluffing and Challenges</strong>: Bluffing is an integral part of the game. Players may bluff in their Jokester calls, leading to strategic decisions and challenges from opponents.</p>
      <h2><strong>Strategy Tips:</strong></h2>
      <ul>
        <li>Keep an eye on the discard pile to predict other players' strategies.</li>
        <li>Use Jokers wisely, as they can be game-changing.</li>
        <li>Keep track of which cards have been played to better anticipate the remaining deck composition.</li>
      </ul>
    </div>
  </div>

  <script>
    const rulesButton = document.getElementById('rulesButton');
    const rulesPopup = document.getElementById('rulesPopup');
    const closeButton = document.getElementById('closeButton');
    const userInput = document.getElementById('user-input');
    const outputDiv = document.getElementById('output');
    const prompt = document.getElementById('prompt');
    const mobileButtons = document.getElementById('mobile-buttons');
    const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
    let currentSuit = 0;

    rulesButton.addEventListener('click', () => {
      rulesPopup.style.display = 'block';
    });

    closeButton.addEventListener('click', () => {
      rulesPopup.style.display = 'none';
    });

    function handleKeyDown(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const commandText = userInput.value.trim();
        if (!commandText) return;
        userInput.disabled = true;
        const lastDiv = outputDiv.lastElementChild;
        if (lastDiv) {
          lastDiv.innerHTML += '&gt; ' + commandText + '<br>';
        } else {
          const newDiv = document.createElement('div');
          newDiv.innerHTML = '&gt; ' + commandText + '<br>';
          outputDiv.appendChild(newDiv);
        }
        outputDiv.scrollTop = outputDiv.scrollHeight;
        document.dispatchEvent(new CustomEvent('input-received', { detail: commandText }));
        userInput.value = '';
        userInput.disabled = false;
        if (isMobile()) {
          userInput.blur();  // Ensure the input field loses focus to prevent keyboard from appearing
        }
      }
    }

    userInput.addEventListener('keydown', handleKeyDown);

    function instaPrint(message) {
      const newDiv = document.createElement('div');
      newDiv.innerHTML = `<br>${message}`;
      outputDiv.appendChild(newDiv);
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    setInterval(() => {
      prompt.className = suits[currentSuit];
      currentSuit = (currentSuit + 1) % suits.length;
    }, 1000);

    // Detect mobile device
    function isMobile() {
      return /Mobi|Android/i.test(navigator.userAgent);
    }

    if (isMobile()) {
      document.body.classList.add('mobile');
      showInitialButtons();
    }

    function showMobileButtons(buttons) {
      mobileButtons.innerHTML = '';
      buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.classList.add('mobile-button');
        btn.innerText = button.label;
        btn.onclick = () => {
          userInput.value += button.value;
        };
        mobileButtons.appendChild(btn);
      });
      const sendButton = document.createElement('button');
      sendButton.classList.add('send-button');
      sendButton.innerText = 'Send';
      sendButton.onclick = () => {
        userInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
      };
      mobileButtons.appendChild(sendButton);
      mobileButtons.style.display = 'flex';
    }

    function showInitialButtons() {
      showMobileButtons([{ label: 'AI', value: 'AI' }]);
    }

    function showNumberButtons() {
      showMobileButtons([
        { label: '1', value: '1' }, { label: '2', value: '2' }, { label: '3', value: '3' },
        { label: '4', value: '4' }, { label: '5', value: '5' }, { label: '6', value: '6' },
        { label: '7', value: '7' }, { label: '8', value: '8' }, { label: '9', value: '9' },
        { label: '0', value: '0' }
      ]);
    }

    function showJokesterButtons() {
      showMobileButtons([
        { label: 'J', value: 'J' }, { label: 'S', value: 'S' }, { label: 'B', value: 'B' }
      ]);
    }

    document.addEventListener('input-received', (event) => {
      const input = event.detail.toLowerCase();
      if (input === 'ai') {
        showNumberButtons();
      } else if (input === 'jokester') {
        showJokesterButtons();
      } else if (['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'].includes(input)) {
        // Handle the number input if needed
      } else if (['j', 's', 'b'].includes(input)) {
        showNumberButtons();
      }
    });
  </script>
  <py-script>
    from js import document, window
    import asyncio
    from pyodide import create_proxy

    output_div = document.getElementById('output')
    user_input = document.getElementById('user-input')

    async def slow_input(prompt):
        await fast_print(prompt)
        user_input.disabled = False
        user_input.focus()

        promise = asyncio.Future()
        def on_input(event):
            command = event.detail
            promise.set_result(command)

        input_handler = create_proxy(on_input)
        document.addEventListener('input-received', input_handler, {'once': True})
        result = await promise
        document.removeEventListener('input-received', input_handler)
        input_handler.destroy()
        user_input.disabled = True
        return result.strip().lower()
  </py-script>
</body>
</html>
